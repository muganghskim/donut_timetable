<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Donut Timetable - Clickable Map (active via ?active=HH or local time)</title>
<style>
  :root { --size: 1000px; --panel-width: 360px; }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: #fafafa;
    padding: 20px;
    box-sizing: border-box;
  }

  /* grid: panel (left) | preview (right) */
  .wrap { width: min(var(--size), calc(100% - 40px)); position: relative; display:grid; grid-template-columns: 0px 1fr; gap:16px; align-items:start; transition: grid-template-columns .18s ease; }
  .panel { width: var(--panel-width); }
  .preview { width: 100%; position: relative; }

  .donut-img { width: 100%; height: auto; display: block; border-radius: 8px; }
  .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  svg { width: 100%; height: 100%; pointer-events: auto; }
  .slice { cursor: pointer; transition: opacity .15s, transform .15s; }
  .slice:hover { opacity: .85; transform: scale(1.02); }
  .slice.active { fill-opacity: 0.28 !important; stroke: #1a73e8 !important; stroke-width: 2.2; }
  .label { font-size: 11px; text-anchor: middle; dominant-baseline: central; fill: #111; pointer-events: none; font-weight:500; }

  /* 설정 패널 */
  #setupForm { background:#fff; border-radius:8px; padding:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); height:calc(100% - 0px); overflow:auto;
               transform: translateX(-8px); transition: transform .22s ease, opacity .18s ease; will-change: transform, opacity; }
  /* hidden state (moved out to left) */
  #setupForm.hidden { transform: translateX(-18px) scale(.98); opacity: 0; pointer-events: none; height: auto; }

  #setupForm h3 { margin:0 0 8px 0; font-size:16px; }
  .inputs { display:grid; grid-template-columns: repeat(1, 1fr); gap:6px; }
  .hour-row { display:flex; gap:8px; align-items:center; }
  .hour-row label { min-width:86px; font-size:13px; color:#333; }
  .hour-row input[type="url"] { flex:1; padding:6px 8px; border:1px solid #ddd; border-radius:5px; font-size:13px; }
  .form-actions { display:flex; gap:8px; margin-top:8px; }
  .btn { padding:8px 10px; border-radius:6px; border:1px solid #cfcfcf; background:#f7f7f7; cursor:pointer; font-size:13px; }
  .btn.primary { background:#1a73e8; color:#fff; border-color:#1765d6; }
  .btn.warn { background:#fff4e5; border-color:#ffd499; }
  .small-note { font-size:12px; color:#666; margin-top:8px; }

  /* 토글 버튼 (도넛 바로 왼쪽 상단으로 이동) */
  #toggleBtn {
    position: absolute;
    left: 12px;   /* 도넛 기준 왼쪽 여백 */
    top: 12px;    /* 도넛 기준 상단 여백 */
    z-index: 60;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  #toggleBtn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
  #toggleBtn.open { background:#1a73e8; color:#fff; border-color:#1765d6; }

  /* mobile adjustments */
  @media (max-width: 920px) {
    .wrap { grid-template-columns: 1fr; }
    .panel { display:none; } /* panel becomes overlay for small screens (handled in JS) */
    #setupForm { position:fixed; left:12px; top:72px; width: calc(100% - 24px); max-width:420px; z-index:80; }
    #toggleBtn { left: 12px; top: 12px; }
  }
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <!-- panel first so it appears on the left in grid -->
  <div class="panel">
    <form id="setupForm" class="hidden" aria-hidden="true" onsubmit="return false;">
      <h3>Donut 링크 설정</h3>
      <div class="small-note">각 시간(0~23)에 해당하는 링크를 입력하세요. 빈 칸이면 클릭 시 안내가 표시됩니다.</div>
      <div id="inputs" class="inputs" style="margin-top:8px;"></div>

      <div class="form-actions">
        <button id="saveBtn" class="btn primary" type="button">저장</button>
        <button id="clearBtn" class="btn warn" type="button">초기화(로컬삭제)</button>
      </div>

      <div class="small-note" style="margin-top:10px;">
        • 저장된 설정은 이 브라우저의 로컬스토리지에 보관됩니다. 브라우저 데이터(쿠키/사이트 데이터)를 지우면 삭제됩니다.
      </div>
    </form>
  </div>

  <div class="preview">
    <!-- Replace this src with your public image URL (or keep pie2.png in the same folder when hosting) -->
    <img id="donutImg" class="donut-img" src="./pie2.png" alt="Donut timetable image" />
    <div class="overlay" role="presentation">
      <svg id="svgOverlay" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet" aria-hidden="false"></svg>
    </div>
    <!-- 토글 버튼 (설정 열기/닫기) -->
    <button id="toggleBtn" aria-expanded="false" title="설정 열기">⚙️</button>
  </div>
</div>



<script>
/* ========== 기본값 (템플릿 배포 시 폴백으로 사용됩니다) ========== */
const defaultSlices = Array.from({length:24}, ()=>"#");
/* ====================================================================== */

const STORAGE_KEY = 'donut_slices';

// 색상, geometry
const colors = [
  "#e6f2ff","#d6e9ff","#c6e1ff","#b6d8ff",
  "#a6cff7","#97c6f0","#87bfeb","#77b6e2",
  "#bfe9c9","#a7e1b1","#8fd99a","#77d184",
  "#ffd9b3","#ffcc99","#ffbf80","#ffb366",
  "#ffd6ec","#ffbfdf","#ffa8d1","#ff92c4",
  "#f6e6ff","#e6d6ff","#d6c6ff","#c6b6ff"
];
const cx = 500, cy = 500, R = 420, r = 220, total = 24;
const startOffset = -Math.PI/2;
const svg = document.getElementById('svgOverlay');

function polarToCartesian(cx, cy, radius, angleRad) {
  return { x: cx + radius * Math.cos(angleRad), y: cy + radius * Math.sin(angleRad) };
}
function makeSectorPath(cx, cy, rInner, rOuter, startAngle, endAngle) {
  const p1 = polarToCartesian(cx, cy, rOuter, startAngle);
  const p2 = polarToCartesian(cx, cy, rOuter, endAngle);
  const p3 = polarToCartesian(cx, cy, rInner, endAngle);
  const p4 = polarToCartesian(cx, cy, rInner, startAngle);
  const largeArc = (endAngle - startAngle) > Math.PI ? 1 : 0;
  return [
    "M", p1.x, p1.y,
    "A", rOuter, rOuter, 0, largeArc, 1, p2.x, p2.y,
    "L", p3.x, p3.y,
    "A", rInner, rInner, 0, largeArc, 0, p4.x, p4.y,
    "Z"
  ].join(" ");
}

// 시간표 레이블 (한국어)
function hourLabel(i) {
  if (i === 0) return "오후 12시";
  if (i < 12) return `오전 ${i}시`;
  if (i === 12) return "오전 12시";
  return `오후 ${i-12}시`;
}

// get initial active index: ?active=HH > local hour > 0
function getInitialActiveIndex() {
  try {
    const params = new URLSearchParams(window.location.search);
    const activeParam = params.get('active');
    if (activeParam !== null) {
      const n = parseInt(activeParam, 10);
      if (!Number.isNaN(n) && n >= 0 && n < 24) return n;
    }
  } catch (e) { /* ignore */ }
  const now = new Date();
  const h = now.getHours();
  if (!Number.isNaN(h)) return h;
  return 0;
}

let activeIdx = getInitialActiveIndex();

/* ======= storage helpers ======= */
function readSlicesFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return null;
    return arr;
  } catch (e) {
    return null;
  }
}
function writeSlicesToStorage(arr) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    return true;
  } catch (e) {
    return false;
  }
}
function getSliceUrl(idx) {
  const stored = readSlicesFromStorage();
  if (stored && stored[idx]) return stored[idx];
  return defaultSlices[idx] || '';
}

/* ======= build SVG slices and labels ======= */
function buildDonut() {
  // clear any existing
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  for (let i = 0; i < total; i++) {
    const a0 = startOffset + (i/total) * Math.PI*2;
    const a1 = startOffset + ((i+1)/total) * Math.PI*2;
    const pathD = makeSectorPath(cx, cy, r, R, a0, a1);

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("fill", colors[i % colors.length]);
    path.setAttribute("fill-opacity", "0.06");
    path.setAttribute("stroke", "#9aa0a6");
    path.setAttribute("stroke-width", "1");
    path.classList.add("slice");

    // click handler: set active + open link (use storage)
    (function(idx, node){
      node.addEventListener('click', function(e){
        e.preventDefault();
        setActive(idx);
        const url = getSliceUrl(idx) || "#";
        if (!url || url.startsWith("#")) {
          alert(`${hourLabel(idx)} 클릭됨 — 링크가 설정되어 있지 않습니다.\n설정 창에서 URL을 입력하고 저장하세요.`);
        } else {
          // 현재 창에서 이동 (새 탭 아님)
          window.location.href = url;
        }
      });
      node.addEventListener('mouseenter', function(){ node.setAttribute("fill-opacity", "0.14"); });
      node.addEventListener('mouseleave', function(){ if(!node.classList.contains('active')) node.setAttribute("fill-opacity", "0.06"); });
    })(i, path);

    const mid = (a0 + a1) / 2;
    const labelPt = polarToCartesian(cx, cy, (r+R)/2, mid);
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", labelPt.x.toFixed(2));
    text.setAttribute("y", labelPt.y.toFixed(2));
    text.setAttribute("class", "label");
    text.textContent = hourLabel(i);

    svg.appendChild(path);
    svg.appendChild(text);
  }
}

/* setActive function */
function setActive(i) {
  const all = svg.querySelectorAll(".slice");
  all.forEach((s, idx) => {
    if (idx === i) {
      s.classList.add("active");
      s.setAttribute("fill-opacity", "0.28");
      s.setAttribute("stroke-width", "2.2");
      s.setAttribute("stroke", "#1a73e8");
    } else {
      s.classList.remove("active");
      s.setAttribute("fill-opacity", "0.06");
      s.setAttribute("stroke-width", "1");
      s.setAttribute("stroke", "#9aa0a6");
    }
  });
  activeIdx = i;
}

/* initial render */
buildDonut();
setActive(activeIdx);

/* keyboard support */
document.addEventListener('keydown', function(e){
  if (e.key === 'ArrowRight') {
    setActive((activeIdx + 1) % total);
  } else if (e.key === 'ArrowLeft') {
    setActive((activeIdx - 1 + total) % total);
  }
});

/* ======= Setup form: build inputs, load/save behavior ======= */
(function setupPanel() {
  const inputsWrap = document.getElementById('inputs');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const formEl = document.getElementById('setupForm');
  const toggleBtn = document.getElementById('toggleBtn');
  const wrapEl = document.getElementById('wrap');

  // create 24 input rows
  for (let i = 0; i < 24; i++) {
    const row = document.createElement('div');
    row.className = 'hour-row';
    const label = document.createElement('label');
    label.setAttribute('for', 'slice-'+i);
    label.textContent = `${i}: ${hourLabel(i)}`;
    const inp = document.createElement('input');
    inp.type = 'url';
    inp.id = 'slice-'+i;
    inp.placeholder = 'https://example.com/... (빈칸 가능)';
    inp.style.minWidth = '120px';
    row.appendChild(label);
    row.appendChild(inp);
    inputsWrap.appendChild(row);
  }

  function loadToForm() {
    const stored = readSlicesFromStorage();
    for (let i = 0; i < 24; i++) {
      const el = document.getElementById('slice-'+i);
      if (stored && stored[i]) el.value = stored[i];
      else el.value = defaultSlices[i] || '';
    }
  }

  function saveFromForm() {
    const arr = [];
    for (let i = 0; i < 24; i++) {
      const v = document.getElementById('slice-'+i).value.trim();
      arr.push(v);
    }
    const ok = writeSlicesToStorage(arr);
    if (ok) {
      alert('설정이 저장되었습니다. (로컬스토리지)');
    } else {
      alert('저장에 실패했습니다. 브라우저 설정을 확인하세요.');
    }
  }

  function clearStorageAndReset() {
    localStorage.removeItem(STORAGE_KEY);
    loadToForm();
    alert('로컬 저장된 설정을 제거하고 기본값으로 복원했습니다.');
  }

  // bind
  saveBtn.addEventListener('click', saveFromForm);
  clearBtn.addEventListener('click', clearStorageAndReset);

  // populate with stored or defaults on open
  loadToForm();

  // toggle behavior (left slide)
  function openPanel() {
    formEl.classList.remove('hidden');
    formEl.setAttribute('aria-hidden', 'false');
    toggleBtn.classList.add('open');
    toggleBtn.setAttribute('aria-expanded', 'true');
    // set grid so left column is panel
    wrapEl.style.gridTemplateColumns = 'var(--panel-width) 1fr';
  }
  function closePanel() {
    formEl.classList.add('hidden');
    formEl.setAttribute('aria-hidden', 'true');
    toggleBtn.classList.remove('open');
    toggleBtn.setAttribute('aria-expanded', 'false');
    wrapEl.style.gridTemplateColumns = '0px 1fr';
  }

  // initialize as closed
  closePanel();

  toggleBtn.addEventListener('click', function(e){
    e.stopPropagation();
    if (formEl.classList.contains('hidden')) openPanel();
    else closePanel();
  });

  // close panel when clicking outside on mobile
  document.addEventListener('click', function(e){
    const isClickInside = formEl.contains(e.target) || toggleBtn.contains(e.target);
    if (!isClickInside && !formEl.classList.contains('hidden')) {
      if (window.innerWidth <= 920) closePanel();
    }
  });

})();
</script>
</body>
</html>
